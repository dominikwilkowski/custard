/***************************************************************************************************************************************************************
 *
 * Testing server
 *
 * The test app spinns up a server on localhost:1337. Requesting this URL via your trusted browser will shoot off a request for Custard.
 * Each request calls three functions each finishing via timeout to simulate a long I/O process. Requesting the URL several times you should see some functions
 * being sacraficed.
 *
 **************************************************************************************************************************************************************/

'use strict';

//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// Dependencies
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
const Express = require('express');
const Custard = require('../prod/prod.js');
const BodyParser = require('body-parser');


//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// Constructor factory
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
const App = (() => {

	return {
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// Settings
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
		DEBUG: true, //debugging infos

//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// Initiate app
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
		init: () => {
			var tester = Express();

			//starting server
			tester
				.use( BodyParser.urlencoded({ extended: false }) )
				.listen(1337, () => {
					console.log('Server started on port 1337');
				});


			tester.get('*', (request, response) => {
				console.log(` Request received! ${Custard.getRequest()}`);


				Custard.run([
					{
						run: App.random.test1,
						maxCalls: 3, //only run this if there are less than 5 processes currently running
						fallback: () => {
							console.log(`X not running test1`);
						},
					},{
						run: App.random.test2,
						maxCalls: 5, //only run this if there are less than 10 processes currently running
						fallback: () => {
							console.log(`X not running test2`);
						},
					},{
						run: App.random.test3, //run this always
						fallback: () => {
							console.log(`X not running test3`); //should never happen
						},
					}
				],
				() => {
					console.log('\n  DONE');
				});


			});

		},
	}

})();




/***************************************************************************************************************************************************************
 *
 * Random app lagger (trademark pending)
 *
 **************************************************************************************************************************************************************/

App.random = (() => {

	return {
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// test method 1
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
		test1: () => {
			console.log(`  called test1 function`);

			setTimeout(() => {
				console.log(`  queue: ${Custard.getQueue()}`);

				Custard.finished();
			}, 5000);
		},


//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// test method 2
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
		test2: () => {
			console.log(`  called test2 function`);

			setTimeout(() => {
				console.log(`  queue: ${Custard.getQueue()}`);

				Custard.finished();
			}, 6000);
		},

//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// test method 3
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
		test3: () => {
			console.log(`  called test3 function`);

			setTimeout(() => {
				console.log(`  queue: ${Custard.getQueue()}`);

				Custard.finished();
			}, 8000);
		},

	}

})();



App.init();